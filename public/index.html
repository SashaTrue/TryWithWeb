<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Holy Days - главная</title>
  <link rel="icon" href="./favicon.svg" type="image/x-icon">
  <link rel="stylesheet" href="./stylesheets/style.css">
  <style>
    .admin-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 5px;
      z-index: 100;
    }
    .category-item {
      position: relative;
      padding-top: 40px;  /* Добавляем отступ сверху для кнопок */
      margin: 10px;
      background-color: #f9f9f9;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    .admin-button {
      padding: 5px 10px;
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .delete-button {
      background: #e24a4a;
    }
    .add-holiday-button {
      margin-left: 10px;
    }

    /* Предотвращаем всплытие события клика для кнопок */
    .admin-controls button {
      pointer-events: auto;
    }

    /* Сетка для карточек */
    .holidays-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    @media (max-width: 768px) {
      .admin-button {
        padding: 3px 6px;
        font-size: 0.6rem;
      }
      .category-item {
        flex: 1 1 100%; /* На мобильных устройствах одна колонка */
      }
    }
  </style>
</head>
<body>
<nav class="navbar">
  <a href="/" class="logo">
    <img src="./images/logo/SaintChel.png" alt="Holy Days Icon">
    <span>Holy Days</span>
  </a>
  <a id="auth-btn" href="/auth/github" class="github-login-btn">Войти через GitHub</a>
</nav>
<div class="nav-container">
  <div class="nav-links">
    <a href="/holidays-by-date">По дате</a>
    <a href="/holidays-by-category">По категориям</a>
  </div>
</div>
<div id="holidays-container" class="holidays-grid"></div>
<script>
  let isAuthenticated = false;
  async function getUserData() {
    try {
      const response = await fetch('/user');
      const data = await response.json();
      const authBtn = document.getElementById('auth-btn');
      if (data.username) {
        isAuthenticated = true;
        authBtn.innerHTML = `
          <img src="${data.avatar_url}" alt="Avatar" class="avatar">
          ${data.username} (Выход)
        `;
        authBtn.href = '/logout';
      } else {
        isAuthenticated = false;
        authBtn.textContent = 'Войти через GitHub';
        authBtn.href = '/auth/github';
      }
      // Перезагружаем праздники после проверки аутентификации
      fetchHolidays(currentPage);
    } catch (error) {
      console.error('Ошибка при получении данных пользователя:', error);
      isAuthenticated = false;
    }
  }
  let currentPage = 1;
  async function fetchHolidays(page = 1) {
    try {
      const response = await fetch(`/holidays?page=${page}&limit=10`);
      const data = await response.json();
      const holidaysContainer = document.getElementById('holidays-container');
      // Создаём HTML для каждого праздника
      console.log('Запрашиваемая страница:', page);
      console.log('Полученные данные с сервера:', data);
      const holidaysHTML = data.holidays.map(holiday => `
            <div class="category-item" data-id="${holiday.id}">
                ${isAuthenticated ? `
                    <div class="admin-controls">
                        <button class="admin-button" onclick="event.stopPropagation(); editHoliday(${holiday.id})">Изменить</button>
                        <button class="admin-button delete-button" onclick="event.stopPropagation(); deleteHoliday(${holiday.id})">Удалить</button>
                    </div>
                ` : ''}
                <div onclick="showHolidayDetails(${holiday.id})">
                    <h2>${holiday.title}</h2>
                    ${holiday.images.length > 0 ?
              `<img class="category-image" src="${holiday.images[0]}" alt="${holiday.title}">` :
              `<img class="category-image" src="./images/default-image.png" alt="${holiday.title}">`
      }
                </div>
            </div>
        `).join('');
      // Создаём HTML для пагинации
      const paginationHTML = `
            <div class="pagination">
                ${page > 1 ? `<button onclick="fetchHolidays(${page - 1})">Предыдущая</button>` : ''}
                ${page < data.pages ? `<button onclick="fetchHolidays(${page + 1})">Следующая</button>` : ''}
                ${isAuthenticated ? `<button class="admin-button add-holiday-button" onclick="addNewHoliday()">Добавить праздник</button>` : ''}
            </div>
        `;
      // Обновляем содержимое контейнера
      holidaysContainer.innerHTML = holidaysHTML + paginationHTML;
    } catch (error) {
      console.error('Ошибка при загрузке праздников:', error);
    }
  }
  function showHolidayDetails(holidayId) {
    window.location.href = `/holiday-details?id=${holidayId}`;
  }
  function editHoliday(holidayId) {
    window.location.href = `/edit-holiday?id=${holidayId}`;
  }
  async function deleteHoliday(holidayId) {
    if (confirm('Вы уверены, что хотите удалить этот праздник?')) {
      try {
        const response = await fetch(`/holidays/${holidayId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        if (response.ok) {
          // Перезагружаем текущую страницу после успешного удаления
          fetchHolidays(currentPage);
        } else {
          alert('Ошибка при удалении праздника');
        }
      } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка при удалении праздника');
      }
    }
  }
  function addNewHoliday() {
    window.location.href = '/add-holiday';
  }
  // Вызываем getUserData() при загрузке страницы
  getUserData();
  async function deleteHoliday(holidayId) {
    if (confirm('Вы уверены, что хотите удалить этот праздник?')) {
      try {
        const response = await fetch(`/holidays/${holidayId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        if (response.ok) {
          // Перезагружаем текущую страницу после успешного удаления
          fetchHolidays(currentPage);
        } else {
          alert('Ошибка при удалении праздника');
        }
      } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка при удалении праздника');
      }
    }
  }
</script>
</body>
</html>